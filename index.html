<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Photo Booth @saphasena68</title>
  <style>
    body{
      font-family: 'Poppins', sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      background:#f0f8ff;
    }
    h1{
      margin:10px;
      font-size:24px;
      color:#333;
    }
    video{
      border:3px solid #87CEEB;
      border-radius:12px;
      margin-bottom:10px;
      max-width:90%;
    }
    .controls{
      margin:10px;
    }
    button{
      padding:10px 16px;
      margin:0 6px;
      border:none;
      border-radius:6px;
      background:#87CEEB;
      color:#fff;
      font-size:16px;
      cursor:pointer;
    }
    button:hover{
      background:#5bb4d6;
    }
    .countdown{
      font-size:48px;
      color:#FFD700;
      font-weight:bold;
      margin:15px;
    }
    .status{
      font-size:18px;
      color:#555;
      margin-bottom:8px;
    }
    .preview{
      display:flex;
      flex-direction:column;
      align-items:center;
      background:#fff;
      width:300px;
      padding:12px;
      border:4px solid #87CEEB;
      border-radius:16px;
      position:relative;
    }
    .stars{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:100%;
      pointer-events:none;
      overflow:hidden;
    }
    .star{
      position:absolute;
      background:yellow;
      border-radius:50%;
      opacity:0.8;
    }
    .thumb{
      width:90%;
      aspect-ratio:3/4;
      margin:6px 0;
      border:2px solid #87CEEB;
      border-radius:10px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:8px;
    }
    canvas{display:none;}
  </style>
</head>
<body>
  <h1>Photo Booth @saphasena68</h1>
  <video id="video" autoplay></video>
  <div class="controls">
    <button id="startBtn">ถ่ายรูป</button>
    <button id="downloadBtn">ดาวน์โหลด</button>
    <button id="printBtn">พิมพ์รูป</button>
  </div>
  <div class="countdown" id="countdown"></div>
  <div class="status" id="status"></div>
  <div class="preview" id="preview">
    <div class="stars" id="stars"></div>
  </div>
  <canvas id="canvas"></canvas>
  <audio id="shutter" src="https://www.soundjay.com/mechanical/camera-shutter-click-03.mp3" preload="auto"></audio>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const countdownEl = document.getElementById('countdown');
    const statusEl = document.getElementById('status');
    const preview = document.getElementById('preview');
    const shutter = document.getElementById('shutter');
    const starsContainer = document.getElementById('stars');

    let captures = [];

    // Camera
    navigator.mediaDevices.getUserMedia({video:true})
      .then(stream => video.srcObject = stream);

    // Countdown capture
    async function captureSequence(){
      captures = [];
      preview.querySelectorAll('.thumb').forEach(t=>t.remove());

      for(let i=0;i<3;i++){
        statusEl.textContent = `กำลังถ่ายรูปที่ ${i+1}/3`;
        await countdown(3);
        const shot = captureImage();
        captures.push(shot);
        addThumbnail(shot);
        shutter.play();
        await new Promise(r=>setTimeout(r,600));
      }
      statusEl.textContent = "ถ่ายครบแล้ว ✔";
    }

    function countdown(sec){
      return new Promise(resolve=>{
        let s = sec;
        countdownEl.textContent = s;
        const timer = setInterval(()=>{
          s--;
          if(s>0){
            countdownEl.textContent = s;
          } else {
            clearInterval(timer);
            countdownEl.textContent = "";
            resolve();
          }
        },1000);
      });
    }

    function captureImage(){
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0);
      return canvas.toDataURL("image/png");
    }

    function addThumbnail(src){
      const div = document.createElement('div');
      div.className="thumb";
      const img = document.createElement('img');
      img.src = src;
      div.appendChild(img);
      preview.appendChild(div);
    }

    // Draw rounded rectangle
    function roundRect(ctx, x, y, w, h, r){
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+w-r, y);
      ctx.quadraticCurveTo(x+w, y, x+w, y+r);
      ctx.lineTo(x+w, y+h-r);
      ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
      ctx.lineTo(x+r, y+h);
      ctx.quadraticCurveTo(x, y+h, x, y+h-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath();
    }

    function drawImageInFrame(ctx, imgSrc, x, y, w, h, r){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        img.onload = function(){
          ctx.save();
          roundRect(ctx, x, y, w, h, r);
          ctx.clip();
          const ratio = Math.max(w / img.width, h / img.height);
          const nw = img.width * ratio;
          const nh = img.height * ratio;
          const dx = x + (w-nw)/2;
          const dy = y + (h-nh)/2;
          ctx.drawImage(img, dx, dy, nw, nh);
          ctx.restore();
          resolve();
        };
        img.onerror = reject;
        img.src = imgSrc;
      });
    }

    downloadBtn.addEventListener('click', async()=>{
      if(captures.length<3){alert("ถ่ายให้ครบก่อน"); return;}
      const dpi = 300, inchW=4, inchH=6;
      canvas.width = inchW*dpi;
      canvas.height = inchH*dpi;
      ctx.fillStyle="#f0f8ff";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // Border
      ctx.lineWidth = 20;
      ctx.strokeStyle="#87CEEB";
      roundRect(ctx,10,10,canvas.width-20,canvas.height-20,40);
      ctx.stroke();

      // Title
      ctx.fillStyle="#333";
      ctx.font="bold 72px Poppins";
      ctx.textAlign="center";
      ctx.fillText("Photo Booth @saphasena68", canvas.width/2,100);

      const photoW = canvas.width*0.7;
      const photoX = (canvas.width-photoW)/2;
      const singleH = (canvas.height-300)/3;
      let y = 150;

      for(let i=0;i<3;i++){
        await drawImageInFrame(ctx, captures[i], photoX, y, photoW, singleH, 40);
        y += singleH + 20;
      }

      const link=document.createElement('a');
      link.download="photobooth.png";
      link.href=canvas.toDataURL("image/png");
      link.click();
    });

    printBtn.addEventListener('click', ()=>{
      if(captures.length<3){alert("ถ่ายให้ครบก่อน"); return;}
      const dataUrl = canvas.toDataURL("image/png");
      const win = window.open("");
      win.document.write(`<img src="${dataUrl}" style="width:100%">`);
      win.print();
    });

    startBtn.addEventListener('click',captureSequence);

    // Generate minimal stars
    function generateStars(){
      for(let i=0;i<40;i++){
        const s = document.createElement('div');
        s.className="star";
        const size = Math.random()*6+3;
        s.style.width = size+"px";
        s.style.height = size+"px";
        s.style.left = Math.random()*100+"%";
        s.style.top = Math.random()*100+"%";
        starsContainer.appendChild(s);
      }
    }
    generateStars();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</body>
</html>
