<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SENA PHOTOBOOTH | OS 2.4 PRINT EDITION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;800&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* === CSS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î === */
        /* (‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ‚Äî
           ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) */
    </style>
</head>
<body>

<!-- === HTML STRUCTURE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î === -->

<script>
const OS = (function() {

    /* ===============================
       CONFIG / STATE / DOM / SOUND
       (‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
       =============================== */

    /* ===============================
       [ADD] REAL IMAGE UPLOAD
       =============================== */
    async function uploadToImgBB(dataUrl) {
        const apiKey = "676d911b6678b8723c3b0f55e3780a47";
        const form = new FormData();
        form.append("image", dataUrl.split(',')[1]);

        const res = await fetch(
            "https://api.imgbb.com/1/upload?key=" + apiKey,
            { method: "POST", body: form }
        );

        const json = await res.json();
        if (!json.success) throw new Error("Upload failed");
        return json.data.url; // URL ‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
    }

    /* ===============================
       simulateServer (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏¥‡∏°)
       =============================== */
    function simulateServer(dataUrl) {
        let p = 0;
        D.serverStatus.querySelector('div').innerText = "> CONNECTING TO SERVER...";
        const int = setInterval(() => {
            p += Math.random() * 20;
            if(p >= 100) {
                p = 100; clearInterval(int);
                D.loadFill.style.width = "100%";
                D.serverStatus.querySelector('div').innerText =
                    "> UPLOAD COMPLETE. ID: " + Math.floor(Math.random()*9999);

                generateQR(dataUrl); // üëà ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
                setTimeout(() => {
                    D.serverStatus.style.display = 'none';
                    D.qrBox.classList.add('show');
                }, 500);
            } else {
                D.loadFill.style.width = p + "%";
                D.serverStatus.querySelector('div').innerText =
                    "> UPLOADING... " + Math.floor(p) + "%";
            }
        }, 150);
    }

    /* ===============================
       [MODIFIED] generateQR
       (‡∏Ç‡∏¢‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏ö)
       =============================== */
    async function generateQR(dataUrl) {
        const qrEl = document.getElementById('qrcode');
        qrEl.innerHTML = "";

        let qrContent = dataUrl; // fallback = ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ñ‡∏∏‡∏ì

        try {
            // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á
            qrContent = await uploadToImgBB(dataUrl);
        } catch (e) {
            console.warn("Upload failed, fallback to DataURL", e);
        }

        new QRCode(qrEl, {
            text: qrContent,
            width: 140,
            height: 140,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ iOS ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏£‡∏á
        qrEl.onclick = () => {
            if (qrContent.startsWith("http")) {
                window.open(qrContent, "_blank");
            }
        };
    }

    /* ===============================
       download + return (‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏î‡∏¥‡∏°)
       =============================== */

    return { start, selectFrame, toggleGrid, filter, snap, download };
})();
</script>

</body>
</html>
