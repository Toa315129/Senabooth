<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Photo Booth @saphasena68</title>
  <style>
    body{
      font-family:sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      background:#f0f8ff;
    }
    h1{margin:10px;}
    video{border:2px solid #87CEEB;border-radius:8px;margin-bottom:10px;}
    .controls{margin:10px;}
    button{padding:8px 14px;margin:0 4px;border:none;border-radius:6px;background:#87CEEB;color:#fff;cursor:pointer;}
    button:hover{background:#5bb4d6;}
    .countdown{font-size:48px;color:#FFD700;font-weight:bold;margin:10px;}
    .preview{display:flex;flex-direction:column;align-items:center;background:#fff;width:300px;padding:10px;border:3px solid #87CEEB;border-radius:12px;}
    .thumb{width:90%;aspect-ratio:3/4;margin:4px 0;border:2px solid #87CEEB;border-radius:8px;overflow:hidden;}
    .thumb img{width:100%;height:100%;object-fit:cover;}
    canvas{display:none;}
  </style>
</head>
<body>
  <h1>Photo Booth @saphasena68</h1>
  <video id="video" autoplay></video>
  <div class="controls">
    <button id="switchBtn">สลับกล้อง</button>
    <button id="startBtn">ถ่ายรูป</button>
    <button id="downloadBtn">ดาวน์โหลด</button>
  </div>
  <div class="countdown" id="countdown"></div>
  <div class="preview" id="preview"></div>
  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const switchBtn = document.getElementById('switchBtn');
    const countdownEl = document.getElementById('countdown');
    const preview = document.getElementById('preview');
    let captures = [];
    let currentFacing = "user"; // เริ่มที่กล้องหน้า
    let stream;

    async function startCamera(){
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video:{facingMode: currentFacing}
      });
      video.srcObject = stream;
    }
    startCamera();

    // countdown
    function countdown(sec){
      return new Promise(resolve=>{
        let s=sec;
        countdownEl.textContent=s;
        const timer=setInterval(()=>{
          s--;
          if(s>0){
            countdownEl.textContent=s;
          }else{
            clearInterval(timer);
            countdownEl.textContent="";
            resolve();
          }
        },1000);
      });
    }

    // capture
    function captureImage(){
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      ctx.drawImage(video,0,0);
      return canvas.toDataURL("image/png");
    }

    function addThumbnail(src){
      const div=document.createElement("div");
      div.className="thumb";
      const img=document.createElement("img");
      img.src=src;
      div.appendChild(img);
      preview.appendChild(div);
    }

    async function captureSequence(){
      captures=[];
      preview.innerHTML="";
      for(let i=0;i<3;i++){
        await countdown(3);
        const shot=captureImage();
        captures.push(shot);
        addThumbnail(shot);
      }
    }

    startBtn.addEventListener("click",captureSequence);

    downloadBtn.addEventListener("click",()=>{
      if(captures.length<3){alert("ถ่ายให้ครบก่อน");return;}
      const link=document.createElement("a");
      link.download="photobooth.png";
      link.href=captures[0]; // ตัวอย่าง ดาวน์โหลดแค่รูปแรก
      link.click();
    });

    // สลับกล้อง
    switchBtn.addEventListener("click",()=>{
      currentFacing = currentFacing==="user" ? "environment" : "user";
      startCamera();
    });
  </script>
</body>
</html>
